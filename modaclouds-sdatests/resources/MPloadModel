#$1=MP-IP
#$2=SDA-IP


curl -i -H "Accept: application/json" -X PUT -d '
{
  "cloudProviders": [
    {
      "id": "amazon",
      "type": "IaaS"
    }
  ],
  "internalComponents": [
    {
      "id": "mic-frontend-mon",
      "providedMethods": [
        "mic-frontend-mon-register",
        "mic-frontend-mon-answerQuestions",
        "mic-frontend-mon-saveAnswers"
      ],
      "requiredComponents": [
        "MIC"
      ],
      "type": "Mic"
    }
  ],

  "methods": [
    {
      "id": "mic-frontend-mon-answerQuestions",
      "type": "answerQuestions"
    },
    {
      "id": "mic-frontend-mon-saveAnswers",
      "type": "saveAnswers"
    },
    {
      "id": "mic-frontend-mon-register",
      "type": "register"
    }
  ],

  "vMs": [
    {
      "cloudProvider": "amazon",
      "id": "MIC",
      "numberOfCPUs": 2,
      "type": "Frontend"
    }
  ]
}
' http://"$1":8170/v1/model/resources

curl -X POST -i -H "Content-type: application/xml" http://"$1":8170/v1/monitoring-rules -d '
<monitoringRules xmlns="http://www.modaclouds.eu/xsd/1.0/monitoring_rules_schema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.modaclouds.eu/xsd/1.0/monitoring_rules_schema">
  <monitoringRule id="cpuRule" timeStep="3" timeWindow="3">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="CpuUtilization">
      <parameter name="samplingProbability">1</parameter>
      <parameter name="samplingTime">3</parameter>
    </collectedMetric>
    <metricAggregation aggregateFunction="Average" groupingClass="VM"/>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">FrontendCPUUtilization</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
<monitoringRule id="cpuStealRule" timeStep="3" timeWindow="3">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="CpuStolen">
      <parameter name="samplingProbability">1</parameter>
      <parameter name="samplingTime">3</parameter>
    </collectedMetric>
    <metricAggregation aggregateFunction="Average" groupingClass="VM"/>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">FrontendCPUStolen</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="respTimeRule" timeStep="2" timeWindow="10">
    <monitoredTargets>
      <monitoredTarget class="Method" type="answerQuestions"/>
      <monitoredTarget class="Method" type="saveAnswers"/>
      <monitoredTarget class="Method" type="register"/>
    </monitoredTargets>
    <collectedMetric metricName="EffectiveResponseTime">
      <parameter name="samplingProbability">1</parameter>
    </collectedMetric>
    <metricAggregation aggregateFunction="Average" groupingClass="Method"/>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">AvarageEffectiveResponseTime</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="sdaHaproxy" timeStep="300" timeWindow="300">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="EstimationCI">
      <parameter name="window">60000</parameter>
      <parameter name="nCPU">2</parameter>
      <parameter name="CPUUtilTarget">MIC</parameter>
      <parameter name="CPUUtilMetric">FrontendCPUUtilization</parameter>
      <parameter name="targetMetric">AvarageEffectiveResponseTime</parameter>
      <parameter name="samplingTime">300</parameter>
      <parameter name="filePath">/home/ubuntu/modaclouds-sda-1.2.2/</parameter>
    </collectedMetric>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">EstimatedDemand</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="sdaForecastFirst" timeStep="300" timeWindow="300">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="ForecastingTimeSeriesARIMA5Min">
      <parameter name="targetMetric">Workload</parameter>
      <parameter name="forecastPeriod">30</parameter>
      <parameter name="autoregressive">1</parameter>
      <parameter name="movingAverage">1</parameter>
      <parameter name="integrated">1</parameter>
      <parameter name="samplingTime">300</parameter>
    </collectedMetric>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">ForecastedWorkload1</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="sdaForecastSecond" timeStep="300" timeWindow="300">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="ForecastingTimeSeriesARIMA10Min">
      <parameter name="targetMetric">Workload</parameter>
      <parameter name="forecastPeriod">60</parameter>
      <parameter name="autoregressive">1</parameter>
      <parameter name="movingAverage">1</parameter>
      <parameter name="integrated">1</parameter>
      <parameter name="samplingTime">300</parameter>
    </collectedMetric>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">ForecastedWorkload2</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="sdaForecastThird" timeStep="300" timeWindow="300">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="ForecastingTimeSeriesARIMA15Min">
      <parameter name="targetMetric">Workload</parameter>
      <parameter name="forecastPeriod">90</parameter>
      <parameter name="autoregressive">1</parameter>
      <parameter name="movingAverage">1</parameter>
      <parameter name="integrated">1</parameter>
      <parameter name="samplingTime">300</parameter>
    </collectedMetric>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">ForecastedWorkload3</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="sdaForecastFourth" timeStep="300" timeWindow="300">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="ForecastingTimeSeriesARIMA20Min">
      <parameter name="targetMetric">Workload</parameter>
      <parameter name="forecastPeriod">120</parameter>
      <parameter name="autoregressive">1</parameter>
      <parameter name="movingAverage">1</parameter>
      <parameter name="integrated">1</parameter>
      <parameter name="samplingTime">300</parameter>
    </collectedMetric>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">ForecastedWorkload4</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="sdaForecastFifth" timeStep="300" timeWindow="300">
    <monitoredTargets>
      <monitoredTarget class="VM" type="Frontend"/>
    </monitoredTargets>
    <collectedMetric metricName="ForecastingTimeSeriesARIMA25Min">
      <parameter name="targetMetric">Workload</parameter>
      <parameter name="forecastPeriod">150</parameter>
      <parameter name="autoregressive">1</parameter>
      <parameter name="movingAverage">1</parameter>
      <parameter name="integrated">1</parameter>
      <parameter name="samplingTime">300</parameter>
    </collectedMetric>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">ForecastedWorkload5</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
  <monitoringRule id="workloadRule" timeStep="10" timeWindow="10">
    <monitoredTargets>
      <monitoredTarget class="Method" type="answerQuestions"/>
      <monitoredTarget class="Method" type="saveAnswers"/>
      <monitoredTarget class="Method" type="register"/>
    </monitoredTargets>
    <collectedMetric metricName="EffectiveResponseTime">
      <parameter name="samplingProbability">1</parameter>
    </collectedMetric>
    <metricAggregation aggregateFunction="Count" groupingClass="Method"/>
    <actions>
      <action name="OutputMetric">
        <parameter name="metric">Workload</parameter>
        <parameter name="value">METRIC</parameter>
        <parameter name="resourceId">ID</parameter>
      </action>
    </actions>
  </monitoringRule>
</monitoringRules>
'
curl -d 'http://'$2':8178/v1/results' http://"$1":8170/v1/metrics/AvarageEffectiveResponseTime/observers
curl -d 'http://'$2':8177/v1/results' http://"$1":8170/v1/metrics/FrontendCPUUtilization/observers
curl -d 'http://'$2':8173/v1/results' http://"$1":8170/v1/metrics/FrontendCPUStolen/observers
curl -d 'http://'$2':8179/v1/results' http://"$1":8170/v1/metrics/EstimatedDemand/observers
curl -d 'http://'$2':8175/v1/results' http://"$1":8170/v1/metrics/ForecastedWorkload1/observers
curl -d 'http://'$2':8180/v1/results' http://"$1":8170/v1/metrics/ForecastedWorkload2/observers
curl -d 'http://'$2':8181/v1/results' http://"$1":8170/v1/metrics/ForecastedWorkload3/observers
curl -d 'http://'$2':8182/v1/results' http://"$1":8170/v1/metrics/ForecastedWorkload4/observers
curl -d 'http://'$2':8183/v1/results' http://"$1":8170/v1/metrics/ForecastedWorkload5/observers
curl -d 'http://'$2':8174/v1/results' http://"$1":8170/v1/metrics/Workload/observers
curl -d 'http://'$2':8176/v1/results' http://"$1":8170/v1/metrics/AvarageEffectiveResponseTime/observers
curl -d 'http://'$2':8176/v1/results' http://"$1":8170/v1/metrics/FrontendCPUUtilization/observers
curl -d 'http://'$2':8176/v1/results' http://"$1":8170/v1/metrics/Workload/observers
